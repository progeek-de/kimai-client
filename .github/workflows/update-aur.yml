name: Update AUR Package

on:
  workflow_run:
    workflows: ["Build and Release"]
    types: [completed]

jobs:
  update-aur:
    name: Update AUR Package
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Extract version from release tag
        run: |
          # Get tag from the triggering workflow
          TAG="${{ github.event.workflow_run.head_branch }}"
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Updating AUR package to version: $VERSION"

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Clone AUR repository
        run: |
          GIT_SSH_COMMAND="ssh -i ~/.ssh/aur" git clone ssh://aur@aur.archlinux.org/kimai.git aur-repo

      - name: Update PKGBUILD version and checksum
        run: |
          cd aur-repo

          # Update version
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          # Download tarball and calculate checksum
          wget -q "https://github.com/progeek-de/kimai-client/releases/download/v${VERSION}/kimai-${VERSION}-linux-portable.tar.gz"
          TARBALL_SHA256=$(sha256sum "kimai-${VERSION}-linux-portable.tar.gz" | cut -d' ' -f1)

          # Get checksums for local files
          DESKTOP_SHA256=$(sha256sum kimai.desktop | cut -d' ' -f1)
          SCRIPT_SHA256=$(sha256sum kimai.sh | cut -d' ' -f1)

          # Update checksums array in PKGBUILD (multi-line)
          sed -i "/^sha256sums=/,/)$/c\\sha256sums=('${TARBALL_SHA256}'\n            '${DESKTOP_SHA256}'\n            '${SCRIPT_SHA256}')" PKGBUILD

      - name: Generate .SRCINFO
        run: |
          cd aur-repo
          docker run --rm -v "$PWD:/pkg" -w /pkg archlinux:latest bash -c "
            pacman -Sy --noconfirm pacman
            makepkg --printsrcinfo > .SRCINFO
          "

      - name: Commit and push to AUR
        run: |
          cd aur-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to version ${VERSION}"
          GIT_SSH_COMMAND="ssh -i ~/.ssh/aur" git push

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/aur
